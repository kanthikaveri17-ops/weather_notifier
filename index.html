<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Weather Notifier</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    #weather { margin-top: 20px; }
    .card { display: inline-block; padding: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
  </style>
</head>
<body>
  <h1>üå¶Ô∏è Weather Notifier</h1>
  <input id="cityInput" type="text" placeholder="Enter city">
  <button onclick="fetchWeatherByCity()">Search</button>

  <div id="weather"></div>

  <script>
    let lastWeather = "";

    async function fetchWeather(data) {
      const res = await fetch("/weather", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      return res.json();
    }

    function showWeather(data) {
      if (data.error) { alert(data.error); return; }

      const html = `
        <div class="card">
          <h2>${data.city}</h2>
          <p>üå°Ô∏è ${data.temp} ¬∞C</p>
          <p>üíß Humidity: ${data.humidity}%</p>
          <p>${data.description}</p>
          <img src="https://openweathermap.org/img/wn/${data.icon}@2x.png">
        </div>`;
      document.getElementById("weather").innerHTML = html;

      // Notify if weather changed
      const current = `${data.city}-${data.temp}-${data.description}`;
      if (current !== lastWeather) {
        lastWeather = current;
        if (Notification.permission === "granted") {
          new Notification(`Weather Update: ${data.city}`, {
            body: `${data.temp}¬∞C, ${data.description}, Humidity: ${data.humidity}%`,
            icon: `https://openweathermap.org/img/wn/${data.icon}.png`
          });
        }
      }
    }

    function fetchWeatherByCity() {
      const city = document.getElementById("cityInput").value;
      fetchWeather({ city }).then(showWeather);
    }

    function fetchWeatherByLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          fetchWeather({ lat: pos.coords.latitude, lon: pos.coords.longitude })
            .then(showWeather);
        });
      }
    }

    // Ask permission for notifications
    if (Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    // Auto fetch weather every 10 minutes
    fetchWeatherByLocation();
    setInterval(fetchWeatherByLocation, 10 * 60 * 1000);
  </script>
</body>
</html>
